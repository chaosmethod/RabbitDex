<!-- Paste this inside your <body> near menu-area or anywhere visible -->
<button id="ptt-test-button" style="position:fixed;left:8px;top:8px;z-index:1000;padding:6px;background:#0f0;border:1px solid #000">PTT TEST</button>

<script>
/* Expanded PTT binding and diagnostics */
(function bindPTTRobust() {
  const pttButton = document.getElementById('ptt-test-button');

  function logEventRaw(name, ev) {
    // stringify small useful fields only
    try {
      const short = {
        type: ev && ev.type,
        detail: ev && ev.detail,
        key: ev && ev.key,
        which: ev && ev.which,
        timeStamp: Math.round(ev.timeStamp || 0)
      };
      log(`[PTT-RAW] ${name} ${JSON.stringify(short)}`);
    } catch (e) {
      log(`[PTT-RAW] ${name} (error serializing event)`);
    }
  }

  async function pttHandlerWrapper(source) {
    log(`[PTT] triggered from ${source}`);
    try {
      if (window._pttBusy) { log('[PTT] busy, ignoring'); return; }
      window._pttBusy = true;
      await doScanAndProcess();
    } catch (e) {
      log('[PTT] handler error: ' + (e && e.message ? e.message : e));
    } finally {
      setTimeout(() => { window._pttBusy = false; }, 700);
    }
  }

  // Candidate event names (common variations and SDK names)
  const names = [
    'sideClick', 'sideclick', 'ptt', 'PTT', 'hardwarePTT',
    'buttonpress', 'buttonPress', 'press', 'pressDown',
    'side-button', 'side_button'
  ];

  // Attach direct listeners to window and document and capture phase
  names.forEach(n => {
    try {
      window.addEventListener(n, function(ev){ logEventRaw(n, ev); pttHandlerWrapper(`window:${n}`); }, true);
      document.addEventListener(n, function(ev){ logEventRaw(n, ev); pttHandlerWrapper(`document:${n}`); }, true);
    } catch (e) {
      // ignore attaching errors
    }
  });

  // Also attach generic 'message' and custom envelopes â€” some runtimes post messages
  window.addEventListener('message', function(ev){
    logEventRaw('message', ev);
    // if message.data indicates PTT, trigger
    try {
      const d = ev && ev.data;
      if (d && (d.type === 'ptt' || d.event === 'sideClick' || d.action === 'ptt')) {
        pttHandlerWrapper('message:event');
      }
    } catch(e){}
  });

  // Keyboard fallback for testing: Space or KeyP
  window.addEventListener('keydown', function(ev){
    if (ev.code === 'Space' || ev.code === 'KeyP') {
      logEventRaw('keydown', ev);
      pttHandlerWrapper('keyboard');
      ev.preventDefault();
    }
  });

  // Visible test button trigger
  if (pttButton) {
    pttButton.addEventListener('click', function(ev){
      logEventRaw('ptt-test-button', ev);
      pttHandlerWrapper('ptt-test-button');
    });
  }

  // Periodic ping to check whether any of the event listeners are being hit (diagnostic)
  let pttSeen = false;
  const originalLog = log;
  // wrap log to detect PTT logs
  window.log = function(msg){
    originalLog(msg);
    try {
      if (typeof msg === 'string' && msg.includes('[PTT-RAW]')) pttSeen = true;
    } catch(e){}
  };

  // After 10s, if no PTT-RAW seen, provide instruction in log
  setTimeout(() => {
    if (!pttSeen) {
      log('[PTT-DIAG] No raw PTT events observed; use green PTT TEST button or press Space/KeyP to simulate PTT and verify capture path');
    } else {
      log('[PTT-DIAG] PTT raw events observed');
    }
  }, 10000);

  log('[PTT-DIAG] Expanded PTT listeners installed (many event names, message, keyboard, test button)');
})();
</script>
