<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>PTT Diagnostic</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    html,body{height:100%;margin:0;padding:0;font-family:Arial,monospace;background:#000;color:#fff;}
    #screen{width:220px;height:180px;margin:12px auto 6px;border:2px solid #fff;background:#111;display:flex;align-items:center;justify-content:center;border-radius:6px;position:relative;overflow:hidden;}
    #camera-preview{width:100%;height:100%;object-fit:cover;background:#222;display:block;}
    #overlay-log{position:fixed;right:8px;top:8px;background:rgba(0,0,0,0.7);color:#0f0;padding:8px;border-radius:6px;font-size:12px;max-width:260px;white-space:pre-line;z-index:9999;}
    #ptt-test-button{position:fixed;left:8px;top:8px;z-index:10000;padding:8px 10px;background:#0f0;border-radius:6px;color:#000;font-weight:bold;border:2px solid #060;cursor:pointer;touch-action:manipulation;}
    #instructions{width:220px;margin:6px auto 0;color:#fff;font-size:12px;text-align:center;}
    button{font:inherit}
  </style>
</head>
<body>
  <div id="ptt-test-button" aria-label="PTT Test">PTT TEST</div>
  <div id="screen">
    <video id="camera-preview" autoplay playsinline></video>
  </div>
  <div id="instructions">Tap PTT TEST or press Space/KeyP. Watch logs (right).</div>
  <div id="overlay-log">logs...</div>

<script>
  (function(){
    const logEl = document.getElementById('overlay-log');
    const pttBtn = document.getElementById('ptt-test-button');
    const videoEl = document.getElementById('camera-preview');
    let cameraStream = null;
    function appendLog(s){ const t = new Date().toISOString().slice(11,19); logEl.textContent = `[${t}] ${s}\n` + logEl.textContent; }

    async function startCamera() {
      appendLog('startCamera() called');
      try {
        cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        videoEl.srcObject = cameraStream;
        await videoEl.play().catch(()=>{});
        appendLog('Camera started (preview attached)');
      } catch (e) {
        appendLog('Camera start error: ' + (e && e.message ? e.message : e));
      }
    }
    async function captureTestImage() {
      if (!cameraStream) {
        appendLog('Camera not started â€” starting now');
        await startCamera();
        await new Promise(r => setTimeout(r, 200));
      }
      if (!videoEl || videoEl.readyState < 2) { appendLog('Video not ready (readyState='+ (videoEl ? videoEl.readyState : 'no') +')'); }
      try {
        const c = document.createElement('canvas');
        c.width = 240; c.height = 282;
        const ctx = c.getContext('2d');
        ctx.drawImage(videoEl, 0, 0, c.width, c.height);
        const dataUrl = c.toDataURL('image/jpeg');
        appendLog('Captured image length: ' + dataUrl.length);
        return dataUrl;
      } catch (err) {
        appendLog('capture error: ' + (err && err.message ? err.message : err));
        throw err;
      }
    }

    // Core PTT handler (used by hardware & simulated)
    async function handlePTT(source) {
      appendLog('PTT fired from: ' + source);
      try {
        await captureTestImage();
        appendLog('Simulated scan complete');
      } catch (e) {
        appendLog('PTT handler error: ' + (e && e.message ? e.message : e));
      }
    }

    // Attach DOM-ready safe listeners
    function attachListeners() {
      // pointer/click/touch for the visible button
      pttBtn.addEventListener('pointerdown', (e) => { e.preventDefault(); appendLog('pointerdown on PTT button'); handlePTT('ptt-test-button-pointer'); }, {passive:false});
      pttBtn.addEventListener('click', (e) => { appendLog('click on PTT button'); handlePTT('ptt-test-button-click'); });

      // keyboard fallback
      window.addEventListener('keydown', (e) => {
        if (e.code === 'Space' || e.code === 'KeyP') {
          appendLog('keyboard -> ' + e.code);
          handlePTT('keyboard');
          e.preventDefault();
        }
      });

      // many possible hardware event names on both window and document (capture phase)
      const eventNames = ['sideClick','sideclick','side-button','side_button','ptt','PTT','buttonpress','press','pressDown','hardwarePTT'];
      eventNames.forEach(name => {
        try {
          window.addEventListener(name, (ev) => { appendLog('[RAW] window.'+name+' event'); appendLog(JSON.stringify({type:ev.type, detail: ev.detail || null, time:Math.round(ev.timeStamp||0)})); handlePTT('window:'+name); }, true);
          document.addEventListener(name, (ev) => { appendLog('[RAW] document.'+name+' event'); appendLog(JSON.stringify({type:ev.type, detail: ev.detail || null, time:Math.round(ev.timeStamp||0)})); handlePTT('document:'+name); }, true);
        } catch (e) {
          appendLog('listener attach failed for ' + name);
        }
      });

      // message envelope (some runtimes post message envelopes)
      window.addEventListener('message', (ev) => {
        appendLog('[RAW] message event data: ' + (typeof ev.data === 'string' ? ev.data.slice(0,200) : JSON.stringify(ev.data)));
        try {
          const d = ev.data;
          if (d && (d.type === 'ptt' || d.event === 'sideClick' || d.action === 'ptt')) handlePTT('message:event');
        } catch(e){}
      });

      appendLog('Listeners attached: pointer, click, keyboard, message, many hardware names');
    }

    // Ensure listeners attach after DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', attachListeners);
    } else {
      attachListeners();
    }

    // Also auto-start camera so you can see preview (optional)
    startCamera().catch(()=>{});
  })();
</script>
</body>
</html>
